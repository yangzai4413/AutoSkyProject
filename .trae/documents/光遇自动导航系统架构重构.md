# 光遇自动导航系统架构重构计划

## 核心改进目标
1. **对抗光照变化**：使用Canny边缘检测替代直接灰度匹配
2. **分辨率适配**：实现归一化处理，支持任意屏幕分辨率
3. **UI交互升级**：引入PIL库，实现数据可视化和实时监控

## 实施步骤

### 1. 安装依赖库
- 安装Pillow库：`pip install Pillow`

### 2. 修改导航核心 (core/navigator.py)
- 引入Canny边缘检测预处理
- 添加`use_edge_feature`参数控制边缘检测开关
- 调整ORB参数以适应边缘特征（增加nfeatures到1000）
- 实现`_preprocess`方法，统一处理图像边缘检测
- 修改`load_waypoint`和`calculate_offset`方法使用边缘检测
- 优化匹配逻辑，适应边缘特征的匹配特点

### 3. 修改主程序 (main.py)
- 添加`capture_and_resize`函数，将截屏缩放到固定大小(640x360)
- 实现`main_loop`函数，接受`stop_event`和`status_callback`参数
- 修改原有`main`函数，支持新的架构
- 统一使用归一化处理，确保所有分辨率下的一致性

### 4. 重写GUI界面 (gui_launcher.py)
- 实现新的UI设计，包含左侧控制区和右侧视觉区
- 使用PIL库加载和显示目标路点图片
- 实现实时数据监控（匹配分、阈值、进度条）
- 添加`status_callback`机制，从导航线程获取实时状态
- 实现定时刷新UI，确保数据实时性

### 5. 测试和验证
- 运行`test_navigation.py`验证导航核心功能
- 测试不同光照条件下的匹配效果
- 测试不同分辨率下的适配效果
- 验证UI界面的实时数据更新

## 预期效果
1. **光照鲁棒性**：在不同光照条件下（晨、昏、阴、晴）都能稳定匹配
2. **分辨率适配**：支持从720p到4K的任意屏幕分辨率
3. **可视化监控**：实时显示匹配分数和目标图片，便于调试和监控
4. **更好的用户体验**：直观的UI设计，便于操作和观察

## 代码变更范围
- `core/navigator.py`：核心导航逻辑重构
- `main.py`：主程序架构调整
- `gui_launcher.py`：全新UI实现
- 新增依赖：Pillow库

## 风险评估
1. **边缘检测参数调整**：Canny阈值需要根据游戏画面特性进行微调
2. **性能影响**：边缘检测会增加计算开销，需要优化参数平衡性能和效果
3. **UI兼容性**：PIL库的图像显示需要确保跨平台兼容性

## 实施顺序
1. 首先修改导航核心，确保边缘检测和归一化处理正常工作
2. 然后修改主程序，实现新的架构
3. 最后重写GUI界面，实现可视化监控
4. 逐步测试，确保每个模块正常工作后再整合

## 验证标准
1. 导航核心能够在不同光照条件下稳定匹配
2. 主程序能够处理任意分辨率的屏幕截图
3. GUI界面能够实时显示导航状态和目标图片
4. 系统能够正常启动、运行和停止，没有异常崩溃

## 后续优化方向
1. 实现更智能的边缘检测参数自适应调整
2. 优化匹配算法，进一步提高匹配速度和准确性
3. 添加更多的可视化调试信息
4. 实现日志系统，便于故障分析和性能优化